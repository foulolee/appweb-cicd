name: CD-Only-From-Existing-Image

on:
  # 수동 실행 시, 이미지를 입력으로 받음
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Existing image tag in 211.34.229.48:5000/appweb (e.g. 20251203160956)"
        required: true
        default: "20251203160956"

permissions:
  contents: write

env:
  REGISTRY: 211.34.229.48:5000
  IMAGE_NAME: appweb
  DEPLOYMENT_FILE: K8s/Deployment_WAS.yaml

jobs:
  deploy-existing-image:
    runs-on: ubuntu-latest   # 더 이상 self-hosted 필요 X (원하면 self-hosted로 둬도 됨)

    steps:
      # 1. 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 입력으로 받은 이미지 태그를 ENV로 셋팅
      - name: Set image tag from input
        run: echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV

      # (옵션) 3. 레지스트리에서 해당 이미지 태그가 실제로 있는지 한번 pull해서 확인
      # 레지스트리에 GitHub Runner에서 접근 가능해야 함.
      # 필요 없으면 이 step은 삭제해도 됨.
      - name: (Optional) Verify image exists in registry
        if: ${{ env.IMAGE_TAG != '' }}
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" \
            | docker login $REGISTRY -u "${{ secrets.REGISTRY_USER }}" --password-stdin
          docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      # 4. K8s Deployment YAML의 image 줄을 새 태그로 교체
      - name: Update k8s deployment image tag
        run: |
          sed -i "s|image:.*|image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG|" "$DEPLOYMENT_FILE"
          echo "Updated image to $REGISTRY/$IMAGE_NAME:$IMAGE_TAG in $DEPLOYMENT_FILE"

      # 5. 변경된 YAML commit + push (ArgoCD가 이 변경을 보고 배포)
      - name: Commit and push manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DEPLOYMENT_FILE"
          git commit -m "Deploy image $REGISTRY/$IMAGE_NAME:$IMAGE_TAG" || echo "No changes to commit"
          git push
