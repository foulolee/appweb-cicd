name: CI-CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

env:
  REGISTRY: 211.34.229.48:5000
  IMAGE_NAME: appweb
  DEPLOYMENT_FILE: K8s/Deployment_WAS.yaml

jobs:
  build-and-deploy:
    # ğŸ‘‰ self-hosted ì•ˆ ì”€, GitHubì—ì„œ ì œê³µí•˜ëŠ” ëŸ¬ë„ˆ ì‚¬ìš©
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 8 + Maven ì„¤ì •
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'
          cache: maven

      # 3. app/ ì—ì„œ WAR ë¹Œë“œ (appweb.war ìƒì„±)
      - name: Build WAR with Maven
        working-directory: ./app
        run: mvn -B clean package

      # 4. ë‚ ì§œ/ì‹œê°„ ê¸°ë°˜ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„± (YYYYMMDDHHMMSS)
      - name: Set image tag (datetime)
        run: echo "IMAGE_TAG=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      # 5. ë ˆì§€ìŠ¤íŠ¸ë¦¬ CA ì¸ì¦ì„œë¥¼ Dockerê°€ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì¹˜
      #    REGISTRY_CA_CRT = /opt/registry/certs/domain.crt ë‚´ìš© ì „ì²´ë¥¼
      #    GitHub Secrets ì— ë“±ë¡í•œ ê°’
      - name: Install registry CA cert for Docker
        run: |
          sudo mkdir -p /etc/docker/certs.d/211.34.229.48:5000
          echo "${{ secrets.REGISTRY_CA_CRT }}" | sudo tee /etc/docker/certs.d/211.34.229.48:5000/ca.crt > /dev/null

      # 6. ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ (ID = rocky, PW = dltkddls ë¥¼
      #    REGISTRY_USER / REGISTRY_PASSWORD Secret ìœ¼ë¡œ ë“±ë¡í•´ë‘ê¸°)
      - name: Log in to registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" \
            | docker login $REGISTRY -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
      #    - ì»¨í…ìŠ¤íŠ¸ëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸(.)
      #    - Dockerfile ì€ docker/Dockerfile
      #    - Dockerfile ì•ˆì—ì„œëŠ” COPY app/target/appweb.war ... ì‚¬ìš©
      - name: Build and push image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f docker/Dockerfile .
          docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      # 8. K8s YAML ì˜ image ì¤„ì„ ìƒˆ íƒœê·¸ë¡œ êµì²´
      - name: Update k8s deployment image tag
        run: |
          sed -i "s|image:.*|image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG|" "$DEPLOYMENT_FILE"
          echo "Updated image tag to $IMAGE_TAG in $DEPLOYMENT_FILE"

      # 9. ë³€ê²½ëœ YAMLì„ commit + push (ArgoCDê°€ ì´ ë³€ê²½ì„ ë³´ê³  ë°°í¬)
      - name: Commit and push manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DEPLOYMENT_FILE"
          git commit -m "Update image tag to $IMAGE_TAG" || echo "No changes to commit"
          git push

